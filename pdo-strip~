<?php

<?php

include_once "Table.class.php";
include_once "functions.php";

// primary keys are the values of the name attributes of the form input elements.
$snippet_form_array = array ( 
			"snippet" => array (
						"name" => "snippet",
						"value" => "",
						"error_mssg" => "",
						"form_label" => "Snippet",
						"type" => "text",
						"validate" => "string"
						),
			"description" => array (
						"name" => "description",
						"value" => "",
						"error_mssg" => "",
						"form_label" => "Describe",
						"type" => "text",
						"validate" => "string"
						),
			"language" => array 	(
						"name" => "language",
						"value" => "",
						"error_mssg" => "",
						"form_label" => "Language",
						"type" => "text",
						"validate" => "string"
						)
);

function showSnippets($statement, $editable) {
	$snippets = "<div><table border=1>";
	while ( $row = $statement->fetchObject() ) {
		$snippets .= "<tr><td><b>".$row->snippet."</b></td><td>".$row->description."</td><td>".$row->language."</td>";
		if($editable) {
			$snippets .= "<td><a href='index.php?pg=edit&id=".$row->id."'>Edit?</a></td>";
			$snippets .= "<td><a href='index.php?pg=delete&id=".$row->id."'>Delete?</a></td>";
		}
		$snippets .= "</tr>";
	}
	$snippets .= "</table>";
	return $snippets;
}

$db = new PDO("mysql:host=localhost;dbname=snippets;charset=utf8mb4", "root", "");
$table = new Table($db);
$action = "index.php";
If (isset($_GET['id'])) {
		$id = htmlentities($_GET['id']); // this is necessary for editing and deleting a particular row
}

If ($_SERVER['REQUEST_METHOD'] == 'POST')	{
	$snippet_form_array = assignPostToFormArray($snippet_form_array);
	$snippet_form_array = validateFormArray($snippet_form_array);
	$is_form_valid = isFormValid($snippet_form_array);

	
	if($is_form_valid === true AND !isset($_GET['id'])) {
		$table->save('snip', $snippet_form_array); // saves post as a new row
	}

	if($is_form_valid === true AND isset($_GET['id'])) {
		$table->updateRow('snip', $snippet_form_array, $id);  // updates a row from an edited post
	}
	header('Location: index.php');
}

If ($_SERVER['REQUEST_METHOD'] != 'POST' AND isset($_GET['id']))	{

			if($_GET['pg']=='edit') {
				$action .= "?id=".$id;
				$statement = $table->getRowToEdit('snip', $id); // gets a row to be edited using id of the row
				$row = $statement->fetchObject();
				
				foreach($snippet_form_array as $key => $array) {
					$snippet_form_array[$key]['value'] = $row->$key;
				}			
			}
			if($_GET['pg']=='delete') {
				$table->deleteRow('snip', $id); // deletes a row using id of the row
			header('Location: index.php');
			}
}





$snippet_form = showForm($action, $snippet_form_array);

$statement = $table->getAll('snip');
$editable = true; // this is an argument for showSnippets() so the displayed info will be editable or not.
$snippets = showSnippets($statement, $editable);

echo '<!DOCTYPE html><html><head><meta charset="utf-8" /><title></title></head>';
echo '<h2>Snippets</h2>'.$snippet_form.'</br>'.$snippets;
echo '<body></body></html>';