<?php

include_once "Table.class.php";
include_once "functions.php";

// primary keys are the values of the name attributes of the form input elements...
// ... and the names of the corresponding columns in a MySQL (or other) table.
// Most but not necessarily all the secondary keys are required to avoid an 'undefined index' error.
$snippet_form_array = array ( 
			"snippet" => array (
						"name" => "snippet",
						"required" => "",
						"value" => "",
						"error_mssg" => "",
						"form_label" => "Snippet",
						"type" => "text",
						"validate" => "unique"
						),
			"description" => array (
						"name" => "description",
						"required" => "",
						"value" => "",
						"error_mssg" => "",
						"form_label" => "Describe",
						"type" => "text",
						"validate" => "string"
						),
			"language" => array 	(
						"name" => "language",
						"required" => "",
						"value" => "",
						"error_mssg" => "",
						"form_label" => "Language",
						"type" => "text",
						"validate" => ""
						)
);

function showSnippets($statement, $editable) {
	$snippets = "<div><table border=1>";
	while ( $row = $statement->fetchObject() ) {
		$snippets .= "<tr><td><b>".$row->snippet."</b></td><td>".$row->description."</td><td>".$row->language."</td>";
		if($editable) {
			$snippets .= "<td><a href='index.php?pg=edit&id=".$row->id."'>Edit?</a></td>";
			$snippets .= "<td><a href='index.php?pg=delete&id=".$row->id."'>Delete?</a></td>";
		}
		$snippets .= "</tr>";
	}
	$snippets .= "</table>";
	return $snippets;
}

$db = new PDO("mysql:host=localhost;dbname=snippets;charset=utf8mb4", "root", "");
$table = new Table($db);
$action = "test-9.php";

if ($_SERVER['REQUEST_METHOD'] == 'POST')
{
	$snippet_form_array = assignPostToFormArray($snippet_form_array);
	$snippet_form_array = validateFormArray($snippet_form_array, $db, 'snip');
	$is_form_valid = isFormValid($snippet_form_array);

	foreach($snippet_form_array as $key => $array)
	{
		if($snippet_form_array[$key]['validate']=='unique')
		{
			$column = $snippet_form_array[$key]['name'];
			$sql = ("SELECT * FROM snip WHERE $column = ?");
			$stmt = $db->prepare($sql);
			$stmt->execute([$snippet_form_array[$key]['value']]);
			$row = $statement->fetchObject();
			if($row !=  null)
			{
				$snippet_form_array[$key]['error_mssg'] .= 'That is already in the database. Please use another value';
			}
		}
	var_dump($row);
	}
}

$snippet_form = showForm($action, $snippet_form_array);

$statement = $table->getAll('snip');
$editable = true; // this is an argument for showSnippets() so the displayed info will be editable or not.
$snippets = showSnippets($statement, $editable);

echo '<!DOCTYPE html><html><head><meta charset="utf-8" /><title></title></head>';
echo '<h2>Snippets</h2>'.$snippet_form.'</br>'.$snippets;
echo '<body></body></html>';
